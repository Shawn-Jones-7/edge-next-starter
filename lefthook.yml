# ==================================================
# Lefthook - ä¼ä¸šçº§ Git Hooks é…ç½®
# æ–‡æ¡£: https://lefthook.dev/configuration/
# ==================================================

# å…¨å±€è®¾ç½®
colors: true
no_tty: false

# ==================================================
# PRE-COMMIT: æœ¬åœ°æäº¤å‰çš„å¿«é€Ÿæ£€æŸ¥
# ç›®æ ‡ï¼šæ•è·åŸºæœ¬æ ¼å¼ã€ç±»å‹å’Œä»£ç è´¨é‡é—®é¢˜
# ==================================================
pre-commit:
  parallel: false # æŒ‰é¡ºåºæ‰§è¡Œï¼Œä¾¿äºå®šä½é—®é¢˜
  commands:
    # 1. æ ¼å¼æ£€æŸ¥ - Prettier
    format-check:
      tags:
        - frontend
        - formatting
      run: pnpm format:check
      fail_text: 'æ ¼å¼æ£€æŸ¥å¤±è´¥ã€‚è¿è¡Œ pnpm format:write ä¿®å¤æ ¼å¼é—®é¢˜ã€‚'

    # 2. ç±»å‹æ£€æŸ¥ - TypeScript
    type-check:
      tags:
        - frontend
        - typescript
      run: pnpm type-check
      fail_text: 'ç±»å‹æ£€æŸ¥å¤±è´¥ã€‚è¯·ä¿®å¤ TypeScript ç±»å‹é”™è¯¯ã€‚'

    # 3. ESLint æ£€æŸ¥
    lint-check:
      tags:
        - frontend
        - quality
      glob: '*.{js,jsx,ts,tsx}'
      run: pnpm lint
      fail_text: 'ESLint æ£€æŸ¥å¤±è´¥ã€‚è¿è¡Œ pnpm lint --fix å°è¯•è‡ªåŠ¨ä¿®å¤ã€‚'

    # 4. æ¶æ„å®ˆå« - ç¦æ­¢ä¸è‰¯å¯¼å…¥æ¨¡å¼
    architecture-guard:
      tags:
        - architecture
      run: |
        echo "æ£€æŸ¥æ¶æ„è§„åˆ™..."
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–°å¢çš„ export * from
        if git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -l "export \* from" 2>/dev/null | grep -v "types/" | grep -v "constants/"; then
          echo "âŒ å‘ç°ç¦æ­¢çš„ 'export * from' è¯­å¥ï¼ˆtypes/ å’Œ constants/ ç›®å½•é™¤å¤–ï¼‰"
          echo "è¯·æ˜¾å¼å¯¼å‡ºéœ€è¦çš„å†…å®¹ï¼Œæˆ–å°†æ–‡ä»¶ç§»è‡³ types/ æˆ– constants/ ç›®å½•"
          exit 1
        fi
        # æ£€æŸ¥æ˜¯å¦æœ‰è·¨ç›®å½•ç›¸å¯¹å¯¼å…¥ ../
        if git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' | xargs grep -l "from ['\"]\\.\\./" 2>/dev/null | grep -v "test\|spec"; then
          echo "âŒ å‘ç°ç¦æ­¢çš„ç›¸å¯¹è·¯å¾„å¯¼å…¥ '../'ï¼ˆæµ‹è¯•æ–‡ä»¶é™¤å¤–ï¼‰"
          echo "è¯·ä½¿ç”¨ @/ åˆ«åå¯¼å…¥"
          exit 1
        fi
        echo "âœ… æ¶æ„è§„åˆ™æ£€æŸ¥é€šè¿‡"
      fail_text: 'æ¶æ„å®ˆå«å¤±è´¥ã€‚è¯·éµå¾ªé¡¹ç›®æ¶æ„è§„èŒƒã€‚'

# ==================================================
# COMMIT-MSG: æäº¤ä¿¡æ¯è§„èŒƒæ£€æŸ¥
# ç›®æ ‡ï¼šç¡®ä¿æäº¤ä¿¡æ¯éµå¾ª Conventional Commits
# ==================================================
commit-msg:
  commands:
    commitlint:
      tags:
        - commitlint
      run: pnpm commitlint --edit {1}
      fail_text: |
        æäº¤ä¿¡æ¯æ ¼å¼é”™è¯¯ã€‚è¯·éµå¾ª Conventional Commits è§„èŒƒï¼š

        æ ¼å¼: <type>(<scope>): <subject>

        type: feat, fix, docs, style, refactor, test, chore, perf, ci, build, revert
        scope: å¯é€‰ï¼Œå½±å“èŒƒå›´
        subject: ç®€çŸ­æè¿°

        ç¤ºä¾‹:
        - feat(auth): add login functionality
        - fix(api): resolve CORS issue
        - docs: update README

# ==================================================
# PRE-PUSH: æ¨é€å‰çš„å®Œæ•´è´¨é‡é—¨ç¦
# ç›®æ ‡ï¼šç¡®ä¿æ¨é€çš„ä»£ç ç¬¦åˆæ‰€æœ‰è´¨é‡æ ‡å‡†
# ==================================================
pre-push:
  parallel: false
  commands:
    # 1. æ„å»ºæ£€æŸ¥
    build-check:
      tags:
        - build
      run: |
        if [ "$RUN_FAST_PUSH" = "1" ]; then
          echo "âš¡ RUN_FAST_PUSH=1ï¼Œè·³è¿‡æ„å»ºæ£€æŸ¥"
          exit 0
        fi
        echo "ğŸ”¨ æ„å»ºæ£€æŸ¥..."
        pnpm build
      fail_text: 'æ„å»ºå¤±è´¥ã€‚è¯·ä¿®å¤æ„å»ºé”™è¯¯åå†æ¨é€ã€‚è®¾ç½® RUN_FAST_PUSH=1 å¯ä¸´æ—¶è·³è¿‡ã€‚'

    # 2. æµ‹è¯•æ£€æŸ¥
    test-check:
      tags:
        - test
      run: |
        echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
        pnpm test
      fail_text: 'æµ‹è¯•å¤±è´¥ã€‚è¯·ç¡®ä¿æ‰€æœ‰æµ‹è¯•é€šè¿‡åå†æ¨é€ã€‚'

    # 3. å¾ªç¯ä¾èµ–æ£€æŸ¥
    circular-check:
      tags:
        - architecture
      run: |
        echo "ğŸ” æ£€æŸ¥å¾ªç¯ä¾èµ–..."
        pnpm circular:check || true
      fail_text: 'å‘ç°å¾ªç¯ä¾èµ–ã€‚è¯·è§£å†³åå†æ¨é€ã€‚'

    # 4. å®‰å…¨å®¡è®¡
    security-check:
      tags:
        - security
      run: |
        echo "ğŸ”’ å®‰å…¨å®¡è®¡..."
        pnpm security:audit
      fail_text: 'å‘ç°å®‰å…¨æ¼æ´ã€‚è¯·è¿è¡Œ pnpm update æ›´æ–°ä¾èµ–åå†æ¨é€ã€‚'

# ==================================================
# POST-MERGE: åˆå¹¶åçš„è‡ªåŠ¨åŒ–ä»»åŠ¡
# ==================================================
post-merge:
  commands:
    install-deps:
      tags:
        - dependencies
      files: git diff-tree -r --name-only --no-commit-id ORIG_HEAD HEAD
      glob: '{package.json,pnpm-lock.yaml}'
      run: |
        echo "ğŸ“¦ æ£€æµ‹åˆ°ä¾èµ–å˜åŒ–ï¼Œè‡ªåŠ¨å®‰è£…..."
        pnpm install
